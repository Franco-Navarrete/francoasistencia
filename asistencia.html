<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Asistencia Mejorado</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; max-width: 1100px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; align-items:center; }
    .col { flex:1 1 240px; min-width:220px; }
    label { font-weight:600; display:block; margin-bottom:6px; }
    select, input[type="text"], input[type="date"], button { padding:8px 10px; border-radius:6px; border:1px solid #cfcfcf; font-size:1rem; width:100%; box-sizing:border-box; }
    button { cursor:pointer; }
    .btn-blue { background:#0a71f5; color:#fff; border:none; }
    .btn-green { background:#28a745; color:#fff; border:none; }
    .btn-red { background:#dc3545; color:#fff; border:none; }
    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:0.95rem; }
    th, td { padding:8px; border:1px solid #ddd; text-align:left; }
    th { background:#333; color:#fff; font-weight:600; }
    .present { background:#d4edda; }
    .absent { background:#f8d7da; }
    #toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#333; color:#fff; padding:10px 18px; border-radius:6px; display:none; z-index:9999; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; }
    .panel { border:1px solid #e0e0e0; padding:12px; border-radius:8px; margin-bottom:12px; }
    h2,h3 { margin:8px 0; }
    .small { font-size:0.9rem; color:#555; }
    @media(min-width:900px){ .col { min-width:260px } }
  </style>
</head>
<body>

  <h2>Registro de Asistencia — Mejorado</h2>

  <div class="panel">
    <div class="row">
      <div class="col">
        <label for="employeeSelect">Empleado</label>
        <select id="employeeSelect"><option value="">Seleccionar empleado...</option></select>
      </div>

      <div class="col">
        <label>&nbsp;</label>
        <div style="display:flex; gap:8px;">
          <button id="registerIngresoBtn" class="btn-green" disabled>Registrar Ingreso</button>
          <button id="registerEgresoBtn" class="btn-red" disabled>Registrar Egreso</button>
        </div>
      </div>
    </div>

    <p id="statusText" class="small"></p>
  </div>

  <div class="panel">
    <h3>Agregar nuevo empleado</h3>
    <div class="row">
      <div class="col">
        <label for="newEmployeeName">Nombre</label>
        <input id="newEmployeeName" type="text" placeholder="Nombre del empleado" />
      </div>
      <div class="col">
        <label for="newEmployeeDNI">DNI</label>
        <input id="newEmployeeDNI" type="text" placeholder="DNI" />
      </div>
      <div class="col">
        <label for="newEmployeePosition">Puesto</label>
        <input id="newEmployeePosition" type="text" placeholder="Puesto" />
      </div>
    </div>
    <div style="margin-top:8px; width:320px;">
      <button id="addEmployeeBtn" class="btn-blue">Agregar Empleado</button>
    </div>
  </div>

  <div class="panel">
    <h3>Filtros</h3>
    <div class="row">
      <div class="col">
        <label for="filterEmployee">Filtrar por empleado</label>
        <select id="filterEmployee"><option value="all">Todos</option></select>
      </div>
      <div class="col">
        <label for="filterType">Filtrar por tipo</label>
        <select id="filterType">
          <option value="all">Todos</option>
          <option value="Ingreso">Ingreso</option>
          <option value="Egreso">Egreso</option>
        </select>
      </div>
      <div class="col">
        <label for="startDate">Fecha desde</label>
        <input id="startDate" type="date" />
      </div>
      <div class="col">
        <label for="endDate">Fecha hasta</label>
        <input id="endDate" type="date" />
      </div>
    </div>

    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="applyFilterBtn">Aplicar filtro</button>
      <button id="clearFilterBtn">Limpiar filtro</button>
      <button id="exportAllBtn" class="btn-blue">Exportar todo (historial) CSV</button>
    </div>
  </div>

  <div class="panel">
    <h3>Movimientos (filtrados)</h3>
    <table id="movementsTable">
      <thead>
        <tr><th>Empleado</th><th>Tipo</th><th>Fecha y Hora</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="panel">
    <h3>Historial del día (empleado seleccionado)</h3>
    <table id="dailyTable">
      <thead><tr><th>Movimiento</th><th>Hora</th></tr></thead>
      <tbody></tbody>
    </table>
    <p class="small">La tabla muestra movimientos del día seleccionado en los filtros (si no hay fecha, usa hoy).</p>
  </div>

  <div class="panel">
    <h3>Horas trabajadas (solo pares Ingreso→Egreso) — fecha seleccionada</h3>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <div style="min-width:220px;">
        <label for="hoursDate">Fecha para cálculo</label>
        <input id="hoursDate" type="date" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="calcHoursBtn">Calcular horas</button>
      </div>
    </div>

    <table id="hoursTable">
      <thead><tr><th>Empleado</th><th>Horas (hh:mm)</th><th>Segundos totales</th></tr></thead>
      <tbody></tbody>
    </table>
    <p class="small">No se computan horas si falta Egreso (elección: opción 2).</p>
  </div>

  <div class="panel">
    <h3>Empleados presentes (último movimiento = Ingreso)</h3>
    <table id="presentTable">
      <thead><tr><th>Empleado</th><th>Puesto</th><th>Último movimiento</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, limit
  } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

  // --- Config Firebase (usar la tuya)
  const firebaseConfig = {
    apiKey: "AIzaSyC33xct8HUvUYHiKayDFaxFzn4cYrswE7U",
    authDomain: "ingreso-y-egreso-b1db2.firebaseapp.com",
    projectId: "ingreso-y-egreso-b1db2",
    storageBucket: "ingreso-y-egreso-b1db2.firebasestorage.app",
    messagingSenderId: "193807042960",
    appId: "1:193807042960:web:4b1d867f86af8a9bf98b15",
    measurementId: "G-HMR0LZBWWP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM
  const employeeSelect = document.getElementById('employeeSelect');
  const registerIngresoBtn = document.getElementById('registerIngresoBtn');
  const registerEgresoBtn = document.getElementById('registerEgresoBtn');

  const addEmployeeBtn = document.getElementById('addEmployeeBtn');
  const newEmployeeName = document.getElementById('newEmployeeName');
  const newEmployeeDNI = document.getElementById('newEmployeeDNI');
  const newEmployeePosition = document.getElementById('newEmployeePosition');

  const filterEmployee = document.getElementById('filterEmployee');
  const filterType = document.getElementById('filterType');
  const startDate = document.getElementById('startDate');
  const endDate = document.getElementById('endDate');
  const applyFilterBtn = document.getElementById('applyFilterBtn');
  const clearFilterBtn = document.getElementById('clearFilterBtn');
  const exportAllBtn = document.getElementById('exportAllBtn');

  const movementsTableBody = document.querySelector('#movementsTable tbody');
  const dailyTableBody = document.querySelector('#dailyTable tbody');
  const hoursDate = document.getElementById('hoursDate');
  const calcHoursBtn = document.getElementById('calcHoursBtn');
  const hoursTableBody = document.querySelector('#hoursTable tbody');
  const presentTableBody = document.querySelector('#presentTable tbody');

  const statusText = document.getElementById('statusText');
  const toast = document.getElementById('toast');

  // Datos locales
  let employees = [];    // {id, name, dni, position}
  let movements = [];    // {id, employee:{id,name}, type, date: Date}
  let lastMovementByEmployee = {}; // empId -> last type string or null

  // Helpers
  function showToast(msg) {
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display = 'none', 2200);
  }

  function formatDateTime(d) {
    return d.toLocaleString('es-AR', { hour:'2-digit', minute:'2-digit', second:'2-digit', day:'2-digit', month:'2-digit', year:'numeric' });
  }

  function formatTime(d) {
    return d.toLocaleTimeString('es-AR', { hour:'2-digit', minute:'2-digit' });
  }

  // Cargar empleados en tiempo real
  function loadEmployeesRealtime() {
    const q = query(collection(db, 'employees'), orderBy('name'));
    onSnapshot(q, snap => {
      employees = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateEmployeeSelects();
      updatePresentList(); // recalcular por si hay cambios
    });
  }

  function updateEmployeeSelects() {
    employeeSelect.innerHTML = '<option value="">Seleccionar empleado...</option>';
    filterEmployee.innerHTML = '<option value="all">Todos</option>';
    employees.forEach(e => {
      const opt = document.createElement('option');
      opt.value = e.id;
      opt.textContent = e.name;
      employeeSelect.appendChild(opt);

      const opt2 = document.createElement('option');
      opt2.value = e.id;
      opt2.textContent = e.name;
      filterEmployee.appendChild(opt2);
    });

    // enable/disable register buttons depending selection
    updateButtons();
  }

  // Cargar movimientos en tiempo real (ordenados por fecha asc)
  function loadMovementsRealtime() {
    const q = query(collection(db, 'movements'), orderBy('date'));
    onSnapshot(q, snap => {
      movements = snap.docs.map(d => {
        const data = d.data();
        // si viene con Timestamp -> usar toDate, si es Date, usarlo
        const raw = data.date;
        let dateObj = raw && typeof raw.toDate === 'function' ? raw.toDate() : (raw instanceof Date ? raw : new Date(raw));
        return { id: d.id, ...data, date: dateObj };
      });
      rebuildLastMovementIndex();
      renderMovementsTable(); // reactivo filtro
      updatePresentList();
      // actualiza tablas dependientes del empleado seleccionado
      const sel = employeeSelect.value;
      if (sel) {
        listenDailyTableForEmployee(sel);
      }
    }, err => {
      console.error('movements snapshot error', err);
    });
  }

  // Reconstruir índice de último movimiento por empleado (para bloquear y present list)
  function rebuildLastMovementIndex() {
    lastMovementByEmployee = {};
    // Movements are ordered asc; last seen will be final
    movements.forEach(m => {
      if (m.employee && m.employee.id) lastMovementByEmployee[m.employee.id] = m.type;
    });
  }

  // Update buttons enable/disable according to selected employee and last movement
  function updateButtons() {
    const empId = employeeSelect.value;
    if (!empId) {
      registerIngresoBtn.disabled = true;
      registerEgresoBtn.disabled = true;
      statusText.textContent = '';
      return;
    }
    const last = lastMovementByEmployee[empId] || null;
    registerIngresoBtn.disabled = (last === 'Ingreso');
    registerEgresoBtn.disabled = (last === 'Egreso');
    statusText.textContent = last ? `Último movimiento: ${last}` : 'Sin movimientos previos';
  }

  // Registrar movimiento (verifica bloqueos localmente con lastMovementByEmployee)
  async function registerMovement(type) {
    const empId = employeeSelect.value;
    if (!empId) { showToast('Seleccioná un empleado'); return; }
    const emp = employees.find(e => e.id === empId);
    if (!emp) { showToast('Empleado no encontrado'); return; }

    const last = lastMovementByEmployee[empId] || null;
    if (last === type) {
      showToast(`No se permite ${type} seguido. Primero ${last === 'Ingreso' ? 'egreso' : 'ingreso'}.`);
      return;
    }

    try {
      await addDoc(collection(db, 'movements'), {
        employee: { id: emp.id, name: emp.name },
        type,
        date: new Date()
      });
      showToast(`${type} registrado para ${emp.name}`);
      // No actualizar local arrays aquí: onSnapshot se encargará
    } catch (e) {
      console.error(e);
      alert('Error al registrar movimiento');
    }
  }

  // Render tabla movimientos con filtros
  function renderMovementsTable() {
    const tbody = movementsTableBody;
    tbody.innerHTML = '';

    // leer filtros
    const fEmp = filterEmployee.value;
    const fType = filterType.value;
    const sDate = startDate.value ? new Date(startDate.value + 'T00:00:00') : null;
    const eDate = endDate.value ? new Date(endDate.value + 'T23:59:59.999') : null;

    // filtrar por cliente
    const filtered = movements.filter(m => {
      if (fEmp && fEmp !== 'all' && m.employee.id !== fEmp) return false;
      if (fType && fType !== 'all' && m.type !== fType) return false;
      if (sDate && m.date < sDate) return false;
      if (eDate && m.date > eDate) return false;
      return true;
    }).slice().reverse(); // mostrar más reciente arriba

    filtered.forEach(m => {
      const tr = document.createElement('tr');
      tr.className = m.type === 'Ingreso' ? 'present' : 'absent';
      tr.innerHTML = `<td>${m.employee.name}</td><td>${m.type}</td><td>${formatDateTime(m.date)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Lista de presentes — último movimiento = Ingreso
  function updatePresentList() {
    presentTableBody.innerHTML = '';
    employees.forEach(emp => {
      const last = lastMovementByEmployee[emp.id] || null;
      if (last === 'Ingreso') {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${emp.name}</td><td>${emp.position || ''}</td><td>${last}</td>`;
        presentTableBody.appendChild(tr);
      }
    });
  }

  // Historial del día para empleado (usa filtro startDate/endDate si existe)
  function listenDailyTableForEmployee(empId) {
    const tbody = dailyTableBody;
    tbody.innerHTML = '';

    // fecha usada para "día": preferir startDate if equal with endDate? We'll use startDate if provided, else today's date
    let chosenDate;
    if (startDate.value && (!endDate.value || startDate.value === endDate.value)) {
      chosenDate = new Date(startDate.value + 'T00:00:00');
    } else {
      const t = new Date();
      chosenDate = new Date(t.getFullYear(), t.getMonth(), t.getDate());
    }
    const start = new Date(chosenDate); start.setHours(0,0,0,0);
    const end = new Date(chosenDate); end.setHours(23,59,59,999);

    const dayMovs = movements.filter(m => m.employee.id === empId && m.date >= start && m.date <= end).slice().reverse();

    dayMovs.forEach(m => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${m.type}</td><td>${formatTime(m.date)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Calcular horas trabajadas por empleado para fecha en hoursDate (solo pares Ingreso->Egreso)
  function calculateHoursForDate(dateStr) {
    const target = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
    const start = new Date(target); start.setHours(0,0,0,0);
    const end = new Date(target); end.setHours(23,59,59,999);

    const result = []; // {empId, empName, totalSeconds}

    employees.forEach(emp => {
      const empMovs = movements.filter(m => m.employee.id === emp.id && m.date >= start && m.date <= end).slice(); // asc
      let totalSeconds = 0;
      for (let i = 0; i < empMovs.length; i++) {
        const m = empMovs[i];
        if (m.type === 'Ingreso') {
          // buscar siguiente Egreso después del ingreso
          const nextE = empMovs.slice(i+1).find(x => x.type === 'Egreso');
          if (nextE) {
            const diff = (nextE.date.getTime() - m.date.getTime()) / 1000; // segundos
            if (diff > 0) totalSeconds += diff;
            // move index to the found egreso to avoid double counting
            const idxNext = empMovs.indexOf(nextE, i+1);
            if (idxNext > i) i = idxNext;
          } else {
            // no hay egreso después (opción 2): no contabilizar
          }
        }
      }
      result.push({ empId: emp.id, empName: emp.name, totalSeconds });
    });

    // render table
    hoursTableBody.innerHTML = '';
    result.forEach(r => {
      const h = Math.floor(r.totalSeconds / 3600);
      const m = Math.floor((r.totalSeconds % 3600) / 60);
      const hhmm = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.empName}</td><td>${hhmm}</td><td>${Math.round(r.totalSeconds)}</td>`;
      hoursTableBody.appendChild(tr);
    });
  }

  // Exportar TODO el historial (movements array) a CSV (opción B: todo el historial)
  function exportAllToCSV() {
    const header = ['id','employee.id','employee.name','type','date_iso','date_local'];
    const rows = movements.map(m => [
      `"${m.id}"`,
      `"${m.employee?.id || ''}"`,
      `"${(m.employee?.name || '').replace(/"/g,'""')}"`,
      `"${m.type}"`,
      `"${m.date.toISOString()}"`,
      `"${formatDateTime(m.date)}"`
    ].join(','));

    const csv = [header.join(','), ...rows].join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=UTF-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `movements_all_${(new Date()).toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // --- Event listeners
  addEmployeeBtn.addEventListener('click', async () => {
    const name = newEmployeeName.value.trim();
    const dni = newEmployeeDNI.value.trim();
    const position = newEmployeePosition.value.trim();
    if (!name || !dni || !position) { alert('Complete todos los campos'); return; }
    try {
      await addDoc(collection(db, 'employees'), { name, dni, position });
      newEmployeeName.value = ''; newEmployeeDNI.value = ''; newEmployeePosition.value = '';
      showToast('Empleado agregado');
    } catch (e) {
      console.error(e);
      alert('Error al agregar empleado');
    }
  });

  registerIngresoBtn.addEventListener('click', () => registerMovement('Ingreso'));
  registerEgresoBtn.addEventListener('click', () => registerMovement('Egreso'));

  employeeSelect.addEventListener('change', () => {
    updateButtons();
    const emp = employeeSelect.value;
    if (emp) listenDailyTableForEmployee(emp);
  });

  applyFilterBtn.addEventListener('click', () => renderMovementsTable());
  clearFilterBtn.addEventListener('click', () => {
    filterEmployee.value = 'all'; filterType.value = 'all'; startDate.value = ''; endDate.value = '';
    renderMovementsTable();
  });

  exportAllBtn.addEventListener('click', exportAllToCSV);

  calcHoursBtn.addEventListener('click', () => {
    const d = hoursDate.value;
    calculateHoursForDate(d);
  });

  filterEmployee.addEventListener('change', () => {
    // si seleccionan un empleado en el filtro y es igual al select principal, actualizar daily
    const sel = filterEmployee.value;
    renderMovementsTable();
  });

  filterType.addEventListener('change', renderMovementsTable);
  startDate.addEventListener('change', renderMovementsTable);
  endDate.addEventListener('change', renderMovementsTable);

  // on page load default dates
  (function initDates() {
    const t = new Date();
    const iso = t.toISOString().slice(0,10);
    // por defecto hoursDate = hoy
    hoursDate.value = iso;
    // por defecto startDate/endDate vacíos (si querés que por defecto sea hoy activá estas)
    // startDate.value = iso; endDate.value = iso;
  })();

  // Inicializar realtime
  loadEmployeesRealtime();
  loadMovementsRealtime();

  // renderMovementsTable periódicamente por si se llama desde elsewhere
  // (lo actualizamos desde onSnapshot ya)

  // small guard: si el user selecciona empleado en filter y quiere ver daily for that employee
  filterEmployee.addEventListener('change', () => {
    if (filterEmployee.value !== 'all') {
      // marcar también en select principal (opcional)
      // employeeSelect.value = filterEmployee.value;
      // updateButtons();
      // listenDailyTableForEmployee(filterEmployee.value);
    }
  });

  // actualizar present list on demand (ya se hace en snapshot pero dejamos función pública)
  window.updatePresentList = updatePresentList;

</script>
</body>
</html>

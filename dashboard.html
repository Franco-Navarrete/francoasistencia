<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Control Asistencias Secretaria de Ambiente — Admin</title>

<!-- SheetJS para exportar XLSX -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
  :root{ --bg:#0d1114; --card:#0f1418; --muted:#98a0a6; --accent:#0a71f5; --accent-2:#0c9a6e; --danger:#e03b3b; }
  *{box-sizing:border-box}
  body{
    margin:0;
    padding:28px;
    font-family:Inter,Arial,sans-serif;
    background:linear-gradient(180deg,#071018,#08121a);
    color:#e6eef6;
  }
  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:16px;
    margin-bottom:20px;
  }
  .logo{
    width:44px;
    height:44px;
    border-radius:10px;
    background:linear-gradient(135deg,var(--accent), #5bc8ff);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    color:#fff;
  }
  h1{ margin:0; font-size:18px }
  .muted{ color:var(--muted); font-size:13px }
  .container{
    display:grid;
    grid-template-columns: 1fr 380px;
    gap:18px;
    align-items:start;
  }
  @media(max-width:1100px){
    .container{ grid-template-columns:1fr }
    header{ flex-direction:column; align-items:flex-start }
  }
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:16px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 8px 24px rgba(2,8,23,0.6);
  }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .col{ flex:1 1 220px; min-width:180px; }
  label{ display:block; color:var(--muted); font-size:13px; margin-bottom:6px; }

  input, select{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    background:rgba(15,23,42,0.85);
    border:1px solid rgba(148,163,184,0.7);
    color:#eaf6ff;
    font-size:14px;
    outline:none;
  }
  select{
    appearance:none;
    -webkit-appearance:none;
    -moz-appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, #eaf6ff 50%),
      linear-gradient(135deg, #eaf6ff 50%, transparent 50%);
    background-position:
      calc(100% - 18px) calc(50% - 4px),
      calc(100% - 12px) calc(50% - 4px);
    background-size:6px 6px, 6px 6px;
    background-repeat:no-repeat;
    padding-right:30px;
  }
  input:focus, select:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(37,99,235,0.6);
  }

  button{
    padding:9px 12px;
    border-radius:10px;
    border:none;
    font-weight:700;
    cursor:pointer;
    color:#fff;
  }
  .btn-blue{ background:linear-gradient(180deg,var(--accent), #2ea0ff); }
  .btn-green{ background:linear-gradient(180deg,var(--accent-2), #2bd184); }
  .btn-red{ background:linear-gradient(180deg,var(--danger), #ff5b5b); }
  button:disabled{ opacity:0.45; cursor:not-allowed; }

  .table-wrap{ overflow:auto; border-radius:8px; margin-top:8px; }
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width:560px;
    color:#eaf6ff;
  }
  th{
    text-align:left;
    padding:12px 14px;
    color:#cfeaff;
    background:transparent;
    font-size:13px;
  }
  td{ padding:12px 14px; border:none; }
  tbody tr:hover{
    background:linear-gradient(90deg, rgba(10,113,245,0.06), rgba(255,255,255,0.01));
    transform:translateY(-1px);
  }
  .small{ font-size:13px; color:var(--muted) }
  .pill{ padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.02); color:var(--muted) }
  #toast{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:22px;
    background:rgba(0,0,0,0.6);
    color:#fff;
    padding:10px 16px;
    border-radius:10px;
    display:none;
    z-index:9999;
  }
  .actions{ display:flex; gap:8px; align-items:center; }
</style>
</head>
<body>

<header>
  <div style="display:flex; gap:12px; align-items:center;">
    <div class="logo">SA</div>
    <div>
      <h1>Control Asistencias</h1>
      <div class="muted">Secretaría de Ambiente — Panel Admin</div>
    </div>
  </div>

  <div style="text-align:right;">
    <div id="userInfo" class="muted">Sin sesión</div>
    <div style="margin-top:8px;" class="actions">
      <button id="logoutBtn" class="btn-red" style="display:none">Cerrar sesión</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- Left: main -->
  <section>
    <!-- Registrar movimiento -->
    <div class="card">
      <h3>Registrar movimiento</h3>
      <div class="row" style="align-items:end;">
        <div class="col">
          <label>Tipo de empleado</label>
          <select id="employeeTypeFilter">
            <option value="all">Todos</option>
            <option value="Semanal">Semanal</option>
            <option value="Pasante">Pasante</option>
          </select>
        </div>
        <div class="col">
          <label>Empleado</label>
          <select id="employeeSelect"><option value="">Seleccionar...</option></select>
        </div>
        <div class="col" style="min-width:220px;">
          <label>&nbsp;</label>
          <div style="display:flex; gap:12px;">
            <button id="btnIngreso" class="btn-green" disabled>Registrar Ingreso</button>
            <button id="btnEgreso" class="btn-red" disabled>Registrar Egreso</button>
          </div>
        </div>
      </div>
      <div id="lastMove" class="small" style="margin-top:12px">Último movimiento: —</div>
    </div>

    <!-- Movimientos -->
    <div class="card" style="margin-top:14px;">
      <h3>Movimientos</h3>
      <div style="display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap;">
        <div style="flex:1 1 180px;">
          <label>Empleado (filtrar)</label>
          <select id="filterEmployee"><option value="all">Todos</option></select>
        </div>
        <div style="flex:1 1 140px;">
          <label>Tipo</label>
          <select id="filterType">
            <option value="all">Todos</option>
            <option>Ingreso</option>
            <option>Egreso</option>
          </select>
        </div>
        <div style="flex:1 1 120px;">
          <label>Desde</label><input id="fStart" type="date" />
        </div>
        <div style="flex:1 1 120px;">
          <label>Hasta</label><input id="fEnd" type="date" />
        </div>
        <div style="align-self:end;">
          <div style="display:flex; gap:8px;">
            <button id="applyFilter" class="btn-blue">Aplicar</button>
            <button id="clearFilter" class="btn-red">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <table id="movTable">
          <thead>
            <tr>
              <th>Empleado</th>
              <th>Tipo</th>
              <th>Fecha y Hora</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Empleados list -->
    <div class="card" style="margin-top:14px;">
      <h3>Empleados</h3>
      <div style="display:flex; gap:12px; margin-bottom:12px; align-items:center;">
        <div style="flex:1 1 320px;">
          <label>Buscar</label>
          <input id="searchEmployee" type="text" placeholder="Buscar por nombre..." />
        </div>
        <div style="min-width:140px;">
          <label>&nbsp;</label>
          <div style="display:flex; gap:8px;">
            <button id="refreshEmployees" class="btn-blue">Refrescar</button>
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <table id="employeesTable">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>DNI</th>
              <th>Puesto</th>
              <th>Tipo</th>
              <th>Horas</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Horas & Export -->
    <div class="card" style="margin-top:14px;">
      <h3>Horas / Export</h3>
      <div class="row" style="align-items:end;">
        <div class="col"><label>Fecha</label><input id="dayCalc" type="date" /></div>
        <div class="col"><label>Mes</label><input id="monthCalc" type="month" /></div>
        <div style="align-self:end; display:flex; gap:8px;">
          <button id="calcDay" class="btn-green">Calcular día</button>
          <button id="calcMonth" class="btn-green">Calcular mes</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table id="hoursTable">
          <thead><tr><th>Empleado</th><th>Normales</th><th>Extras</th><th>Segundos</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px; align-items:flex-start; flex-wrap:wrap;">
        <div style="min-width:220px;">
          <label>Exportar (CSV crudo)</label>
          <div><button id="exportCSV" class="btn-blue">Exportar CSV</button></div>
        </div>
        <div style="min-width:220px;">
          <label>Exportar TODOS (XLSX limpio)</label>
          <div><button id="exportAllXLSX" class="btn-blue">Exportar TODOS (XLSX)</button></div>
        </div>
        <div style="min-width:260px;">
          <label>Exportar mes (XLSX Ingreso/Egreso)</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="monthCalcExport" type="month" />
            <button id="exportXLSX" class="btn-blue">Exportar XLSX</button>
          </div>
        </div>
      </div>

    </div>

  </section>

  <!-- Right: admin tools -->
  <aside>
    <div class="card">
      <h3>Agregar / Editar empleado</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1 1 240px;">
          <label>Nombre</label>
          <input id="empName" type="text" />
        </div>
        <div style="flex:1 1 160px;">
          <label>DNI</label>
          <input id="empDNI" type="text" />
        </div>
        <div style="flex:1 1 160px;">
          <label>Puesto</label>
          <input id="empPos" type="text" />
        </div>
        <div style="flex:1 1 160px;">
          <label>Tipo</label>
          <select id="empType">
            <option value="">Seleccionar...</option>
            <option value="Semanal">Semanal</option>
            <option value="Pasante">Pasante</option>
          </select>
        </div>
        <div style="flex:1 1 140px;">
          <label>Horas por jornada</label>
          <input id="empHours" type="number" min="1" max="12" step="0.5" placeholder="4" />
        </div>
        <div style="min-width:160px; align-self:end; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="addEmpBtn" class="btn-blue">Agregar</button>
          <button id="cancelEditBtn" class="btn-red" style="display:none;">Cancelar</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h3>Presentes</h3>
      <div class="table-wrap" style="max-height:240px; overflow:auto;">
        <table id="presentTable">
          <thead><tr><th>Empleado</th><th>Puesto</th><th>Último</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h3>Información</h3>
      <p class="small">Panel: <strong>Control Asistencias Secretaria de Ambiente</strong></p>
      <p class="small">Jornada por defecto (si no se define en el empleado): <span class="pill">4h</span></p>
      <p class="small">Admins permitidos: <span class="pill">franco.e.navarrete@gmail.com</span><span class="pill">fatilopez@gmail.com</span> <span class="pill">eduardomoyano@hotmail.com</span></p>
    </div>
  </aside>
</main>

<div id="toast"></div>

<!-- ===================== SCRIPT ===================== -->
<script type="module">
/* imports */
import { db, auth } from './firebase.js';
import {
  collection, addDoc, onSnapshot, query, orderBy,
  deleteDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
import {
  onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";

/* DOM */
const userInfo = document.getElementById('userInfo');
const logoutBtn = document.getElementById('logoutBtn');

const employeeTypeFilter = document.getElementById('employeeTypeFilter');
const employeeSelect = document.getElementById('employeeSelect');
const btnIngreso = document.getElementById('btnIngreso');
const btnEgreso = document.getElementById('btnEgreso');
const lastMoveEl = document.getElementById('lastMove');

const filterEmployee = document.getElementById('filterEmployee');
const filterType = document.getElementById('filterType');
const fStart = document.getElementById('fStart');
const fEnd = document.getElementById('fEnd');
const applyFilter = document.getElementById('applyFilter');
const clearFilter = document.getElementById('clearFilter');

const movTableBody = document.querySelector('#movTable tbody');
const employeesTableBody = document.querySelector('#employeesTable tbody');
const searchEmployee = document.getElementById('searchEmployee');
const refreshEmployeesBtn = document.getElementById('refreshEmployees');

const empNameI = document.getElementById('empName');
const empDNI = document.getElementById('empDNI');
const empPos = document.getElementById('empPos');
const empType = document.getElementById('empType');
const empHoursI = document.getElementById('empHours');
const addEmpBtn = document.getElementById('addEmpBtn');
const cancelEditBtn = document.getElementById('cancelEditBtn');

const presentTableBody = document.querySelector('#presentTable tbody');

const calcDayBtn = document.getElementById('calcDay');
const calcMonthBtn = document.getElementById('calcMonth');
const dailyDate = document.getElementById('dayCalc');
const monthCalc = document.getElementById('monthCalc');
const hoursTableBody = document.querySelector('#hoursTable tbody');

const exportCSVBtn = document.getElementById('exportCSV');
const exportXLSXBtn = document.getElementById('exportXLSX');
const exportAllXLSXBtn = document.getElementById('exportAllXLSX');
const exportMonthInput = document.getElementById('monthCalcExport');

const toast = document.getElementById('toast');

/* state */
let employees = [];
let movements = []; // {id, employee:{id,name}, type, date: Date}
let lastMovement = {};
let currentUser = null;
let editingEmployeeId = null;

/* admins allowed */
const ALLOWED_ADMINS = ['franco.e.navarrete@gmail.com','eduardomoyano@hotmail.com'];

/* constants */
const JORNADA_HORAS_DEFAULT = 4;

/* helpers */
function showToast(msg, t=2200){
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(()=> toast.style.display='none', t);
}
function formatDateTime(d){
  return d.toLocaleString('es-AR', {
    hour:'2-digit', minute:'2-digit', second:'2-digit',
    day:'2-digit', month:'2-digit', year:'numeric'
  });
}
function secsToHHMM(sec){
  const h=Math.floor(sec/3600);
  const m=Math.floor((sec%3600)/60);
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function getEmpJornadaSeg(emp){
  const h = typeof emp.jornadaHoras === 'number'
    ? emp.jornadaHoras
    : (emp.jornadaHoras ? Number(emp.jornadaHoras) : JORNADA_HORAS_DEFAULT);
  const horasValidas = !isNaN(h) && h > 0 ? h : JORNADA_HORAS_DEFAULT;
  return horasValidas * 3600;
}

function resetEmpForm(){
  empNameI.value='';
  empDNI.value='';
  empPos.value='';
  empType.value='';
  empHoursI.value='';
  editingEmployeeId = null;
  addEmpBtn.textContent = 'Agregar';
  addEmpBtn.classList.remove('btn-green');
  addEmpBtn.classList.add('btn-blue');
  if (cancelEditBtn) cancelEditBtn.style.display = 'none';
}

/* -- AUTH guard -- */
onAuthStateChanged(auth, user => {
  currentUser = user;
  if (!user) {
    window.location.href = 'index.html';
    return;
  }
  const email = (user.email || '').toLowerCase();
  if (!ALLOWED_ADMINS.includes(email)) {
    showToast('Acceso denegado para este usuario', 3500);
    signOut(auth).then(()=> window.location.href = 'index.html');
    return;
  }

  userInfo.textContent = `Conectado: ${user.email}`;
  logoutBtn.style.display = 'inline-block';

  loadEmployeesRealtime();
  loadMovementsRealtime();
});

/* logout */
logoutBtn.addEventListener('click', async ()=> {
  await signOut(auth);
  window.location.href = 'index.html';
});

/* FIRESTORE realtime: employees */
function loadEmployeesRealtime(){
  const q = query(collection(db,'employees'), orderBy('name'));
  onSnapshot(q, snap => {
    employees = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    refreshEmployeeSelects();
    renderEmployeesTable();
    refreshPresentList();
  }, err => console.error('employees snapshot', err));
}

/* FIRESTORE realtime: movements */
function loadMovementsRealtime(){
  const q = query(collection(db,'movements'), orderBy('date'));
  onSnapshot(q, snap => {
    movements = snap.docs.map(d => {
      const data = d.data();
      const raw = data.date;
      const date = raw && typeof raw.toDate === 'function'
        ? raw.toDate()
        : (raw instanceof Date ? raw : new Date(raw));
      return { id: d.id, ...data, date };
    });
    rebuildLast();
    renderMovements();
    refreshPresentList();
  }, err => console.error('movements snapshot', err));
}

/* refresh selects and lists */
function refreshEmployeeSelects(){
  const typeFilter = employeeTypeFilter ? employeeTypeFilter.value : 'all';

  employeeSelect.innerHTML = '<option value="">Seleccionar...</option>';
  filterEmployee.innerHTML = '<option value="all">Todos</option>';

  employees.forEach(e => {
    // filtro select de movimientos
    const o2 = document.createElement('option');
    o2.value = e.id;
    o2.textContent = e.name;
    filterEmployee.appendChild(o2);

    // select principal según tipo
    if (typeFilter !== 'all' && e.type !== typeFilter) return;

    const o = document.createElement('option');
    o.value = e.id;
    o.textContent = e.name;
    employeeSelect.appendChild(o);
  });

  updateButtons();
}

/* employees table */
function renderEmployeesTable(filterText){
  employeesTableBody.innerHTML = '';
  const filter = (filterText || (searchEmployee && searchEmployee.value) || '').toLowerCase();
  employees.forEach(emp => {
    if(!filter || emp.name.toLowerCase().includes(filter)){
      const tr = document.createElement('tr');
      const horas = emp.jornadaHoras != null ? emp.jornadaHoras : JORNADA_HORAS_DEFAULT;
      tr.innerHTML = `
        <td>${emp.name}</td>
        <td>${emp.dni||''}</td>
        <td>${emp.position||''}</td>
        <td>${emp.type || ''}</td>
        <td>${horas}</td>
        <td style="text-align:right;">
          <div style="display:flex; gap:6px; justify-content:flex-end;">
            <button data-id="${emp.id}" class="btn-blue btn-edit-emp" style="padding:6px 8px;border-radius:8px;">Editar</button>
            <button data-id="${emp.id}" class="btn-red btn-delete-emp" style="padding:6px 8px;border-radius:8px;">Eliminar</button>
          </div>
        </td>`;
      employeesTableBody.appendChild(tr);
    }
  });

  // listeners eliminar
  document.querySelectorAll('.btn-delete-emp').forEach(b => {
    b.addEventListener('click', async (ev) => {
      const id = ev.currentTarget.dataset.id;
      const emp = employees.find(x=>x.id===id);
      if(!emp) return showToast('Empleado no encontrado');
      if(!confirm(`Confirmar eliminar a ${emp.name} (esto no borrará movimientos automáticamente)`)) return;

      if (editingEmployeeId === id) resetEmpForm();

      try {
        await deleteDoc(doc(db, 'employees', id));
        showToast('Empleado eliminado');
      } catch (err) {
        console.error(err);
        showToast('Error al eliminar');
      }
    });
  });

  // listeners editar
  document.querySelectorAll('.btn-edit-emp').forEach(b => {
    b.addEventListener('click', (ev) => {
      const id = ev.currentTarget.dataset.id;
      const emp = employees.find(x=>x.id===id);
      if(!emp) return showToast('Empleado no encontrado');

      empNameI.value = emp.name || '';
      empDNI.value = emp.dni || '';
      empPos.value = emp.position || '';
      empType.value = emp.type || '';
      empHoursI.value = emp.jornadaHoras != null ? emp.jornadaHoras : JORNADA_HORAS_DEFAULT;

      editingEmployeeId = id;
      addEmpBtn.textContent = 'Guardar cambios';
      addEmpBtn.classList.remove('btn-blue');
      addEmpBtn.classList.add('btn-green');
      if (cancelEditBtn) cancelEditBtn.style.display = 'inline-block';
    });
  });
}

/* search / refresh */
if (searchEmployee) searchEmployee.addEventListener('input', ()=> renderEmployeesTable(searchEmployee.value));
if (refreshEmployeesBtn) refreshEmployeesBtn.addEventListener('click', ()=> {
  loadEmployeesRealtime();
  showToast('Recargando...');
});

/* cancelar edición */
if (cancelEditBtn) cancelEditBtn.addEventListener('click', () => {
  resetEmpForm();
});

/* filtro tipo empleado en registrar movimiento */
if (employeeTypeFilter) employeeTypeFilter.addEventListener('change', () => {
  employeeSelect.value = '';
  refreshEmployeeSelects();
  updateButtons();
  updateLastMoveUI();
});

/* add / update employee */
addEmpBtn.addEventListener('click', async () => {
  const name = empNameI.value?.trim();
  const dni = empDNI.value?.trim();
  const position = empPos.value?.trim();
  const type = empType.value;
  const horas = empHoursI.value ? parseFloat(empHoursI.value) : JORNADA_HORAS_DEFAULT;

  if(!name || !dni || !position || !type) return showToast('Complete todos los campos');
  if(isNaN(horas) || horas <= 0) return showToast('Ingrese horas válidas (>0)');

  try {
    if (editingEmployeeId) {
      await updateDoc(doc(db,'employees', editingEmployeeId), {
        name, dni, position, type, jornadaHoras: horas
      });
      showToast('Empleado actualizado');
    } else {
      await addDoc(collection(db,'employees'), {
        name, dni, position, type, jornadaHoras: horas
      });
      showToast('Empleado agregado');
    }
    resetEmpForm();
  } catch (err) {
    console.error(err);
    showToast('Error al guardar empleado');
  }
});

/* rebuild last */
function rebuildLast(){
  lastMovement = {};
  movements.forEach(m => {
    if(m.employee && m.employee.id) lastMovement[m.employee.id] = m.type;
  });
  updateButtons();
  updateLastMoveUI();
}

/* update buttons (ingreso/egreso) */
function updateButtons(){
  const sel = employeeSelect.value;
  if(!sel){
    btnIngreso.disabled=true;
    btnEgreso.disabled=true;
    lastMoveEl.textContent='';
    return;
  }
  const last = lastMovement[sel] || null;
  btnIngreso.disabled = (last === 'Ingreso');
  btnEgreso.disabled = (last === 'Egreso');
}

/* register movement */
btnIngreso.addEventListener('click', ()=> registerMovement('Ingreso'));
btnEgreso.addEventListener('click', ()=> registerMovement('Egreso'));

async function registerMovement(type){
  if(!currentUser) return showToast('Iniciá sesión');
  const empId = employeeSelect.value;
  if(!empId) return showToast('Seleccioná empleado');
  const emp = employees.find(e=>e.id===empId);
  if(!emp) return showToast('Empleado no encontrado');
  const last = lastMovement[empId] || null;
  if(last === type) return showToast(`No se permite ${type} seguido`);
  try {
    await addDoc(collection(db,'movements'), {
      employee: { id: emp.id, name: emp.name },
      type,
      date: new Date(),
      by: currentUser.uid
    });
    showToast(`${type} registrado para ${emp.name}`);
  } catch (err) {
    console.error(err);
    showToast('Error al registrar movimiento');
  }
}

/* update last move UI */
function updateLastMoveUI(){
  const sel = employeeSelect.value;
  if(!sel){
    lastMoveEl.textContent = 'Último movimiento: —';
    return;
  }
  const lm = lastMovement[sel] || 'Sin movimientos';
  lastMoveEl.textContent = `Último movimiento: ${lm}`;
}

/* listen select change */
employeeSelect.addEventListener('change', ()=> {
  updateButtons();
  updateLastMoveUI();
  renderMovements();
});

/* Movements rendering with filters + eliminar individual */
function renderMovements(){
  movTableBody.innerHTML = '';
  const fEmp = filterEmployee.value;
  const fType = filterType.value;
  const s = fStart.value ? new Date(fStart.value + 'T00:00:00') : null;
  const e = fEnd.value ? new Date(fEnd.value + 'T23:59:59.999') : null;

  const filtered = movements.filter(m => {
    if(fEmp && fEmp !== 'all' && m.employee.id !== fEmp) return false;
    if(fType && fType !== 'all' && m.type !== fType) return false;
    if(s && m.date < s) return false;
    if(e && m.date > e) return false;
    return true;
  }).slice().reverse();

  filtered.forEach(m => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${m.employee.name}</td>
      <td>${m.type}</td>
      <td>${formatDateTime(m.date)}</td>
      <td style="text-align:right;">
        <button data-id="${m.id}" class="btn-red btn-del-mov" style="padding:6px 8px; border-radius:8px;">
          Eliminar
        </button>
      </td>
    `;
    movTableBody.appendChild(tr);
  });

  document.querySelectorAll('.btn-del-mov').forEach(btn => {
    btn.addEventListener('click', async (ev) => {
      const id = ev.currentTarget.dataset.id;
      if (!confirm("¿Seguro que querés eliminar este movimiento?")) return;
      try {
        await deleteDoc(doc(db, "movements", id));
        showToast("Movimiento eliminado");
      } catch (err) {
        console.error(err);
        showToast("Error al eliminar movimiento");
      }
    });
  });
}

/* filters listeners */
if(applyFilter) applyFilter.addEventListener('click', renderMovements);
if(clearFilter) clearFilter.addEventListener('click', ()=> {
  filterEmployee.value = 'all';
  filterType.value = 'all';
  fStart.value=''; fEnd.value='';
  renderMovements();
});
if (filterEmployee) filterEmployee.addEventListener('change', renderMovements);
if (filterType)     filterType.addEventListener('change', renderMovements);
if (fStart)         fStart.addEventListener('change', renderMovements);
if (fEnd)           fEnd.addEventListener('change', renderMovements);

/* present list */
function refreshPresentList(){
  presentTableBody.innerHTML = '';
  employees.forEach(emp=>{
    const last = lastMovement[emp.id] || null;
    if(last === 'Ingreso'){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${emp.name}</td><td>${emp.position||''}</td><td>${last}</td>`;
      presentTableBody.appendChild(tr);
    }
  });
}

/* Calculate hours for day */
if(calcDayBtn) calcDayBtn.addEventListener('click', () => {
  const date = dailyDate.value;
  renderHoursForDate(date);
});
if(calcMonthBtn) calcMonthBtn.addEventListener('click', () => {
  const month = monthCalc.value;
  renderMonth(month);
});

function renderHoursForDate(dateStr){
  const target = dateStr ? new Date(dateStr+'T00:00:00') : new Date();
  const start = new Date(target); start.setHours(0,0,0,0);
  const end = new Date(target); end.setHours(23,59,59,999);
  const rows = [];
  employees.forEach(emp => {
    const em = movements
      .filter(m=>m.employee.id===emp.id && m.date>=start && m.date<=end)
      .slice().sort((a,b)=>a.date-b.date);
    let total=0;
    for(let i=0;i<em.length;i++){
      if(em[i].type==='Ingreso'){
        const nextE = em.slice(i+1).find(z=>z.type==='Egreso');
        if(nextE){
          total += Math.max(0, (nextE.date.getTime()-em[i].date.getTime())/1000);
          const idx = em.indexOf(nextE,i+1);
          if(idx>i) i=idx;
        }
      }
    }
    const jornadaSeg = getEmpJornadaSeg(emp);
    const normal = Math.min(total, jornadaSeg);
    const extra = Math.max(total - jornadaSeg, 0);
    rows.push({ name: emp.name, normal, extra, total });
  });
  hoursTableBody.innerHTML = '';
  rows.forEach(r => {
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${secsToHHMM(r.normal)}</td><td>${secsToHHMM(r.extra)}</td><td>${Math.round(r.total)}</td>`;
    hoursTableBody.appendChild(tr);
  });
}

/* render month (usa la misma tabla hoursTable) */
function renderMonth(monthStr){
  if(!monthStr) return showToast('Seleccioná mes');
  const [y,m] = monthStr.split('-').map(Number);
  const start = new Date(y, m-1, 1); start.setHours(0,0,0,0);
  const end = new Date(y, m, 1); end.setMilliseconds(-1);
  const out = [];
  employees.forEach(emp=>{
    const em = movements
      .filter(x=>x.employee.id===emp.id && x.date>=start && x.date<=end)
      .slice().sort((a,b)=>a.date-b.date);
    const dayTotals = {};
    for(let i=0;i<em.length;i++){
      if(em[i].type==='Ingreso'){
        const nextE = em.slice(i+1).find(z=>z.type==='Egreso');
        if(nextE){
          const sec = Math.max(0,(nextE.date.getTime()-em[i].date.getTime())/1000);
          const key = new Date(
            em[i].date.getFullYear(),
            em[i].date.getMonth(),
            em[i].date.getDate()
          ).toISOString().slice(0,10);
          dayTotals[key]=(dayTotals[key]||0)+sec;
          const idx = em.indexOf(nextE,i+1);
          if(idx>i) i=idx;
        }
      }
    }
    const jornadaSeg = getEmpJornadaSeg(emp);
    let normal=0, extra=0, total=0;
    for(const d in dayTotals){
      const s=dayTotals[d];
      total+=s;
      normal+=Math.min(s, jornadaSeg);
      extra+=Math.max(s - jornadaSeg, 0);
    }
    out.push({ name: emp.name, normal, extra, total });
  });
  hoursTableBody.innerHTML = '';
  out.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${secsToHHMM(r.normal)}</td><td>${secsToHHMM(r.extra)}</td><td>${Math.round(r.total)}</td>`;
    hoursTableBody.appendChild(tr);
  });
}

/* Export CSV (crudo) */
if(exportCSVBtn) exportCSVBtn.addEventListener('click', ()=> {
  const header = ['id','employee.id','employee.name','type','date_iso','date_local'];
  const rows = movements.map(m =>
    [`"${m.id}"`,
     `"${m.employee.id}"`,
     `"${(m.employee.name||'').replace(/"/g,'""')}"`,
     `"${m.type}"`,
     `"${m.date.toISOString()}"`,
     `"${formatDateTime(m.date)}"`].join(',')
  );
  const csv = [header.join(','), ...rows].join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=UTF-8;' });
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`movements_all_${(new Date()).toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast('CSV generado');
});

/* Export TODOS en XLSX: Empleado, Fecha, Hora ingreso, Hora egreso, Horas trabajadas */
if (exportAllXLSXBtn) exportAllXLSXBtn.addEventListener('click', exportAllToXLSX);

function exportAllToXLSX() {
  const rows = [
    ["Empleado", "Fecha", "Hora ingreso", "Hora egreso", "Horas trabajadas"]
  ];

  const ordered = movements.slice().sort((a,b) => a.date - b.date);

  const byEmp = {};
  ordered.forEach(m => {
    const id = m.employee.id;
    if (!byEmp[id]) byEmp[id] = { name: m.employee.name, movs: [] };
    byEmp[id].movs.push(m);
  });

  Object.values(byEmp).forEach(empData => {
    const empName = empData.name;
    const movs = empData.movs;

    for (let i = 0; i < movs.length; i++) {
      const m = movs[i];
      if (m.type === 'Ingreso') {
        const ingreso = m;
        const inDate = ingreso.date;

        const fechaStr = inDate.toLocaleDateString('es-AR', {
          day:'2-digit', month:'2-digit', year:'numeric'
        });
        const inStr = inDate.toLocaleTimeString('es-AR', {
          hour:'2-digit', minute:'2-digit', second:'2-digit'
        });

        const nextE = movs.slice(i+1).find(z => z.type === 'Egreso');
        let outStr = '';
        let workedStr = '';

        if (nextE) {
          outStr = nextE.date.toLocaleTimeString('es-AR', {
            hour:'2-digit', minute:'2-digit', second:'2-digit'
          });

          const diffSec = Math.max(0, (nextE.date.getTime() - inDate.getTime()) / 1000);
          workedStr = secsToHHMM(diffSec);

          const idx = movs.indexOf(nextE, i+1);
          if (idx > i) i = idx;
        }

        rows.push([empName, fechaStr, inStr, outStr, workedStr]);
      }
    }
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Movimientos');

  const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  const blob = new Blob([wbout], { type:'application/octet-stream' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `movimientos_completos_${new Date().toISOString().slice(0,10)}.xlsx`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast('XLSX creado');
}

/* Export XLSX mensual: Empleado, Fecha, Ingreso, Egreso, Horas trabajadas */
if(exportXLSXBtn) exportXLSXBtn.addEventListener('click', ()=> {
  const monthStr = exportMonthInput.value;
  exportMonthToXLSX(monthStr);
});

function exportMonthToXLSX(monthStr){
  if(!monthStr) return showToast('Seleccioná mes');
  const [y,m] = monthStr.split('-').map(Number);
  const start = new Date(y, m-1, 1); start.setHours(0,0,0,0);
  const end = new Date(y, m, 1); end.setMilliseconds(-1);

  const rows = [['Empleado','Fecha','Horario de ingreso','Horario de egreso','Horas trabajadas']];

  employees.forEach(emp => {
    const em = movements
      .filter(x=>x.employee.id===emp.id && x.date>=start && x.date<=end)
      .slice().sort((a,b)=>a.date-b.date);

    for(let i=0;i<em.length;i++){
      if(em[i].type === 'Ingreso'){
        const ingreso = em[i];
        const nextE = em.slice(i+1).find(z=>z.type==='Egreso');
        const inDate = ingreso.date;

        const fechaStr = inDate.toLocaleDateString('es-AR', {
          day:'2-digit', month:'2-digit', year:'numeric'
        });
        const inStr = inDate.toLocaleTimeString('es-AR', {
          hour:'2-digit', minute:'2-digit', second:'2-digit'
        });

        let outStr = '';
        let workedStr = '';

        if(nextE){
          outStr = nextE.date.toLocaleTimeString('es-AR', {
            hour:'2-digit', minute:'2-digit', second:'2-digit'
          });

          const diffSec = Math.max(0, (nextE.date.getTime() - inDate.getTime()) / 1000);
          workedStr = secsToHHMM(diffSec);

          const idx = em.indexOf(nextE, i+1);
          if(idx>i) i = idx;
        }

        rows.push([emp.name, fechaStr, inStr, outStr, workedStr]);
      }
    }
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Movimientos');

  const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  const blob = new Blob([wbout], { type:'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`movimientos_${monthStr}.xlsx`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast('XLSX creado');
}
</script>
</body>
</html>
